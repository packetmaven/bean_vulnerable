package com.beanvulnerable.aeg;

import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Exploit Template System.
 *
 * Template-based PoC generation for common vulnerability patterns.
 */
public class ExploitTemplate {

    private final String templateId;
    private final String templateName;
    private final String vulnerabilityType;
    private final String templateCode;
    private final Set<String> placeholders;

    public static final String SQL_INJECTION_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "import java.sql.*;",
        "",
        "public class SQLInjectionPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String url = \"jdbc:mysql://localhost:3306/testdb\";",
        "        String user = \"root\";",
        "        String password = \"password\";",
        "",
        "        Connection conn = DriverManager.getConnection(url, user, password);",
        "        Statement stmt = conn.createStatement();",
        "",
        "        // Vulnerable code",
        "        String userId = \"$USER_INPUT$\";",
        "        String query = \"SELECT * FROM users WHERE id = \" + userId;",
        "",
        "        System.out.println(\"Query: \" + query);",
        "        ResultSet rs = stmt.executeQuery(query);",
        "",
        "        while (rs.next()) {",
        "            System.out.println(\"User: \" + rs.getString(\"name\"));",
        "        }",
        "",
        "        rs.close();",
        "        stmt.close();",
        "        conn.close();",
        "    }",
        "}"
    );

    public static final String COMMAND_INJECTION_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "import java.io.*;",
        "",
        "public class CommandInjectionPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        // Vulnerable code",
        "        String userInput = \"$USER_INPUT$\";",
        "        String cmd = \"ls \" + userInput;",
        "",
        "        System.out.println(\"Executing: \" + cmd);",
        "        Process p = Runtime.getRuntime().exec(cmd);",
        "",
        "        BufferedReader br = new BufferedReader(",
        "            new InputStreamReader(p.getInputStream())",
        "        );",
        "",
        "        String line;",
        "        while ((line = br.readLine()) != null) {",
        "            System.out.println(line);",
        "        }",
        "",
        "        br.close();",
        "        p.waitFor();",
        "    }",
        "}"
    );

    public static final String PATH_TRAVERSAL_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "import java.nio.file.*;",
        "import java.util.*;",
        "",
        "public class PathTraversalPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        // Vulnerable code",
        "        String userInput = \"$USER_INPUT$\";",
        "        String filename = userInput;",
        "",
        "        System.out.println(\"Reading file: \" + filename);",
        "        byte[] contents = Files.readAllBytes(Paths.get(filename));",
        "",
        "        System.out.println(new String(contents));",
        "    }",
        "}"
    );

    public static final String XPATH_INJECTION_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "import javax.xml.xpath.*;",
        "import org.w3c.dom.*;",
        "import org.xml.sax.*;",
        "import javax.xml.parsers.*;",
        "",
        "public class XPathInjectionPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String xmlContent = \"<users>\" +",
        "            \"<user><name>admin</name><password>secret</password></user>\" +",
        "            \"<user><name>user1</name><password>pass1</password></user>\" +",
        "            \"</users>\";",
        "",
        "        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();",
        "        Document doc = dbf.newDocumentBuilder()",
        "            .parse(new org.xml.sax.InputSource(",
        "                new java.io.StringReader(xmlContent)",
        "            ));",
        "",
        "        // Vulnerable code",
        "        String userName = \"$USER_INPUT$\";",
        "        String xpath = \"//user[name='\" + userName + \"']\";",
        "",
        "        System.out.println(\"XPath: \" + xpath);",
        "        XPathFactory xpf = XPathFactory.newInstance();",
        "        XPath xp = xpf.newXPath();",
        "        NodeList nodes = (NodeList) xp.evaluate(xpath, doc,",
        "            XPathConstants.NODESET);",
        "",
        "        for (int i = 0; i < nodes.getLength(); i++) {",
        "            Element user = (Element) nodes.item(i);",
        "            System.out.println(\"Found: \" +",
        "                user.getElementsByTagName(\"name\").item(0)",
        "                    .getTextContent());",
        "        }",
        "    }",
        "}"
    );

    public static final String XSS_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "public class XssPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String userInput = \"$USER_INPUT$\";",
        "        String html = \"<html><body>\" + userInput + \"</body></html>\";",
        "        System.out.println(html);",
        "    }",
        "}"
    );

    public static final String DESERIALIZATION_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "import java.io.*;",
        "import java.util.*;",
        "",
        "public class DeserializationPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        // Simulate receiving serialized object from untrusted source",
        "        byte[] serializedData = Base64.getDecoder().decode(\"$SERIALIZED_GADGET$\");",
        "",
        "        ByteArrayInputStream bais = new ByteArrayInputStream(serializedData);",
        "        ObjectInputStream ois = new ObjectInputStream(bais);",
        "",
        "        // Vulnerable code: Deserializing untrusted data",
        "        try {",
        "            Object obj = ois.readObject();",
        "            System.out.println(\"Deserialized: \" + obj);",
        "            // Gadget chain executes during deserialization",
        "        } catch (Exception e) {",
        "            System.out.println(\"Deserialization triggered (RCE executed)\");",
        "            e.printStackTrace();",
        "        }",
        "",
        "        ois.close();",
        "    }",
        "}"
    );

    public static final String LDAP_INJECTION_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "public class LdapInjectionPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String user = \"$USER_INPUT$\";",
        "        String filter = \"(uid=\" + user + \")\";",
        "",
        "        java.util.Hashtable<String, String> env = new java.util.Hashtable<>();",
        "        env.put(javax.naming.Context.INITIAL_CONTEXT_FACTORY, \"com.sun.jndi.ldap.LdapCtxFactory\");",
        "        env.put(javax.naming.Context.PROVIDER_URL, \"ldap://localhost:389\");",
        "",
        "        javax.naming.directory.DirContext ctx = new javax.naming.directory.InitialDirContext(env);",
        "        try {",
        "            javax.naming.directory.SearchControls controls = new javax.naming.directory.SearchControls();",
        "            controls.setSearchScope(javax.naming.directory.SearchControls.SUBTREE_SCOPE);",
        "            ctx.search(\"dc=example,dc=com\", filter, controls);",
        "            System.out.println(\"LDAP filter: \" + filter);",
        "        } finally {",
        "            try { ctx.close(); } catch (Exception ignored) {}",
        "        }",
        "    }",
        "}"
    );

    public static final String XXE_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "public class XxePoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String systemId = \"$USER_INPUT$\";",
        "        String xml = \"<?xml version=\\\"1.0\\\"?>\" +",
        "            \"<!DOCTYPE foo [<!ENTITY xxe SYSTEM \\\"\" + systemId + \"\\\">]>\" +",
        "            \"<foo>&xxe;</foo>\";",
        "",
        "        javax.xml.parsers.DocumentBuilderFactory dbf = javax.xml.parsers.DocumentBuilderFactory.newInstance();",
        "        javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();",
        "        org.w3c.dom.Document doc = db.parse(",
        "            new org.xml.sax.InputSource(new java.io.StringReader(xml))",
        "        );",
        "        System.out.println(doc.getDocumentElement().getTextContent());",
        "    }",
        "}"
    );

    public static final String EL_INJECTION_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "public class ElInjectionPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String expr = \"$USER_INPUT$\";",
        "        Class<?> clazz = Class.forName(\"javax.el.ELProcessor\");",
        "        Object processor = clazz.getConstructor().newInstance();",
        "        Object result = clazz.getMethod(\"eval\", String.class)",
        "            .invoke(processor, expr);",
        "        System.out.println(\"EL result: \" + result);",
        "    }",
        "}"
    );

    public static final String HTTP_RESPONSE_SPLITTING_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "public class HttpResponseSplittingPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String headerValue = \"$USER_INPUT$\";",
        "        String response = \"HTTP/1.1 302 Found\\r\\n\" +",
        "            \"Location: /app?next=\" + headerValue + \"\\r\\n\" +",
        "            \"Content-Length: 0\\r\\n\\r\\n\";",
        "        System.out.println(response);",
        "    }",
        "}"
    );

    public static final String URL_REDIRECT_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "public class UrlRedirectPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String target = \"$USER_INPUT$\";",
        "        System.out.println(\"Redirecting to: \" + target);",
        "    }",
        "}"
    );

    public static final String REFLECTION_INJECTION_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "public class ReflectionInjectionPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String className = \"$USER_INPUT$\";",
        "        Class<?> clazz = Class.forName(className);",
        "        Object instance = clazz.getDeclaredConstructor().newInstance();",
        "        System.out.println(\"Loaded: \" + instance.getClass().getName());",
        "    }",
        "}"
    );

    public static final String FILE_OPERATION_TEMPLATE = String.join("\n",
        "package com.beanvulnerable.exploit;",
        "",
        "public class FileOperationPoC {",
        "    public static void main(String[] args) throws Exception {",
        "        String fileName = \"$USER_INPUT$\";",
        "        java.io.FileOutputStream fos = new java.io.FileOutputStream(fileName);",
        "        fos.write(\"test\".getBytes(\"UTF-8\"));",
        "        fos.close();",
        "    }",
        "}"
    );

    public ExploitTemplate(String templateId, String templateName,
                           String vulnerabilityType, String templateCode) {
        this.templateId = templateId;
        this.templateName = templateName;
        this.vulnerabilityType = vulnerabilityType;
        this.templateCode = templateCode;
        this.placeholders = extractPlaceholders(templateCode);
    }

    private Set<String> extractPlaceholders(String code) {
        Set<String> placeholderSet = new HashSet<>();
        Pattern pattern = Pattern.compile("\\$(\\w+)\\$");
        Matcher matcher = pattern.matcher(code);

        while (matcher.find()) {
            placeholderSet.add(matcher.group(1));
        }

        return placeholderSet;
    }

    public String substitutePlaceholder(String placeholder, String value) {
        String escapedValue = escapeJavaString(value);
        return templateCode.replace(
            "$" + placeholder + "$",
            escapedValue
        );
    }

    public String substituteAll(Map<String, String> substitutions) {
        String result = templateCode;

        for (Map.Entry<String, String> entry : substitutions.entrySet()) {
            result = result.replace(
                "$" + entry.getKey() + "$",
                escapeJavaString(entry.getValue())
            );
        }

        return result;
    }

    private String escapeJavaString(String str) {
        if (str == null) {
            return "";
        }
        return str
            .replace("\\", "\\\\")
            .replace("\"", "\\\"")
            .replace("\n", "\\n")
            .replace("\r", "\\r")
            .replace("\t", "\\t");
    }

    public String getTemplateId() {
        return templateId;
    }

    public String getTemplateName() {
        return templateName;
    }

    public String getVulnerabilityType() {
        return vulnerabilityType;
    }

    public Set<String> getPlaceholders() {
        return new HashSet<>(placeholders);
    }

    public String getTemplateCode() {
        return templateCode;
    }
}
